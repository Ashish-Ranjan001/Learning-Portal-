<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
  <div class="loading-content">
    <div class="loading-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
    <h3 class="loading-title">Loading Course Content</h3>
    <div class="loading-dots"><span></span><span></span><span></span></div>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-container">
  <div class="error-content">
    <div class="error-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h3>Something went wrong</h3>
    <p>{{ error }}</p>
    <button class="btn btn-primary retry-btn" (click)="retryLoad()">
      <i class="fas fa-redo me-2"></i>
      Try Again
    </button>
  </div>
</div>

<!-- Tab Switch Warning -->
<div *ngIf="showTabWarning" class="tab-warning-overlay">
  <div class="tab-warning-content">
    <div class="warning-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h4>⚠️ Warning!</h4>
    <p>Tab switching detected! One more attempt will auto-submit your quiz.</p>
    <div class="warning-timer"></div>
  </div>
</div>

<!-- Quiz Modal -->
<div *ngIf="showQuiz" class="quiz-overlay">
  <div class="quiz-container">
    <!-- Quiz Header -->
    <div class="quiz-header">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h2 class="quiz-title mb-2">
            <i class="fas fa-clipboard-check me-2"></i>
            Course Assessment
          </h2>
          <div class="quiz-progress-info">
            Question {{ currentQuestionIndex + 1 }} of
            {{ quizQuestions.length }}
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="quiz-timer">
            <div class="timer-display">
              <i class="fas fa-clock me-2"></i>
              {{ formatTime(timeRemaining) }}
            </div>
            <div class="timer-progress-bar">
              <div
                class="timer-progress"
                [style.width.%]="getTimerProgress()"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Content -->
    <div class="quiz-body" *ngIf="!quizCompleted">
      <div class="question-section">
        <div class="question-number">Q{{ currentQuestionIndex + 1 }}</div>
        <h4 class="question-text">
          {{ quizQuestions[currentQuestionIndex].question }}
        </h4>
      </div>

      <div class="options-section">
        <div
          *ngFor="
            let option of quizQuestions[currentQuestionIndex]?.options;
            let i = index
          "
          class="option-card"
          [class.selected]="selectedAnswers[currentQuestionIndex] === i"
          (click)="selectOption(i)"
        >
          <div class="option-radio">
            <div
              class="radio-inner"
              *ngIf="selectedAnswers[currentQuestionIndex] === i"
            ></div>
          </div>
          <span class="option-text">{{ option }}</span>
          <div
            class="option-check"
            *ngIf="selectedAnswers[currentQuestionIndex] === i"
          >
            <i class="fas fa-check"></i>
          </div>
        </div>
      </div>

      <div class="quiz-actions text-end">
        <button
          class="btn btn-primary btn-lg next-btn"
          [disabled]="selectedAnswers[currentQuestionIndex] === undefined"
          (click)="nextQuestion()"
        >
          {{
            currentQuestionIndex === quizQuestions.length - 1
              ? "Submit Quiz"
              : "Next Question"
          }}
          <i class="fas fa-arrow-right ms-2"></i>
        </button>
      </div>
    </div>

    <!-- Quiz Results -->
    <div class="quiz-results" *ngIf="quizCompleted">
      <div class="results-header text-center">
        <div
          class="score-circle"
          [class.passed]="quizScore >= 70"
          [class.failed]="quizScore < 70"
        >
          <div class="score-percentage">{{ quizScore }}%</div>
          <div class="score-status">
            {{ quizScore >= 70 ? "PASSED" : "FAILED" }}
          </div>
        </div>
      </div>

      <div class="results-stats">
        <div class="row text-center">
          <div class="col-4">
            <div class="stat-card">
              <i class="fas fa-check-circle text-success"></i>
              <div class="stat-number">{{ correctAnswers }}</div>
              <div class="stat-label">Correct</div>
            </div>
          </div>
          <div class="col-4">
            <div class="stat-card">
              <i class="fas fa-times-circle text-danger"></i>
              <div class="stat-number">
                {{ quizQuestions.length - correctAnswers }}
              </div>
              <div class="stat-label">Incorrect</div>
            </div>
          </div>
          <div class="col-4">
            <div class="stat-card">
              <i class="fas fa-percentage text-info"></i>
              <div class="stat-number">{{ quizScore }}%</div>
              <div class="stat-label">Score</div>
            </div>
          </div>
        </div>
      </div>

      <div class="results-actions text-center">
        <button
          class="btn btn-success me-3"
          (click)="completeQuiz()"
          [disabled]="isSubmittingQuiz"
        >
          <i class="fas fa-spinner fa-spin me-2" *ngIf="isSubmittingQuiz"></i>
          <i class="fas fa-check me-2" *ngIf="!isSubmittingQuiz"></i>
          {{ isSubmittingQuiz ? "Saving..." : "Complete" }}
        </button>
        <button
          class="btn btn-outline-primary"
          (click)="retakeQuiz()"
          *ngIf="quizScore < 70 && !isSubmittingQuiz"
        >
          <i class="fas fa-redo me-2"></i>
          Retake Quiz
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div *ngIf="!loading && !error && courseDetail" class="course-container">
  <!-- Animated Background -->
  <div class="animated-background">
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>
    <div class="bg-particles">
      <div class="particle" *ngFor="let p of [1, 2, 3, 4, 5, 6, 7, 8]"></div>
    </div>
  </div>

  <!-- Header -->
  <header class="course-header">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-auto">
          <button class="btn btn-outline-light back-btn" (click)="goBack()">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Courses
          </button>
        </div>
        <div class="col">
          <div class="course-info">
            <h1 class="course-title">{{ courseDetail.courseName }}</h1>
            <div class="progress-section">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <div class="progress-bar-wrapper">
                    <div class="progress progress-custom">
                      <div
                        class="progress-bar progress-bar-animated"
                        [style.width.%]="courseDetail.progress || 0"
                        role="progressbar"
                      >
                        <span class="progress-text"
                          >{{ courseDetail.progress || 0 }}% Complete</span
                        >
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <div class="progress-stats">
                    <span class="stat-item">
                      <strong>{{ completedModules }}</strong> /
                      {{ totalModules }} Modules
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <div class="main-content">
    <div class="container-fluid">
      <div class="row g-4">
        <!-- Sidebar -->
        <div class="col-lg-4 col-xl-3">
          <div class="modules-sidebar">
            <div class="sidebar-header">
              <h4 class="sidebar-title">
                <i class="fas fa-list-ul me-2"></i>
                Course Modules
              </h4>
              <div class="completion-badge" *ngIf="allModulesCompleted">
                <i class="fas fa-trophy me-1"></i>
                Complete!
              </div>
            </div>

            <div class="modules-list">
              <div
                *ngFor="let module of courseDetail.modules; let i = index"
                class="module-item"
                [class.active]="selectedModule?.moduleId === module.moduleId"
                [class.completed]="module.isCompleted"
                (click)="selectModule(module)"
              >
                <div class="module-number">{{ i + 1 }}</div>

                <div class="module-content">
                  <div class="module-header">
                    <h4 class="module-title">{{ module.moduleName }}</h4>
                    <div class="module-status">
                      <i [class]="getModuleStatusIcon(module)"></i>
                    </div>
                  </div>

                  <div class="module-meta">
                    <span class="module-type">
                      <i [class]="getModuleIcon(module)" class="me-1"></i>
                      {{ getModuleDuration(module) || "Video Content" }}
                    </span>
                  </div>
                </div>

                <div class="module-arrow">
                  <i class="fas fa-chevron-right"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Area -->
        <div class="col-lg-8 col-xl-9">
          <div class="content-area">
            <div *ngIf="selectedModule" class="module-details">
              <!-- Module Header -->
              <div class="content-header">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      {{ courseDetail.courseName }}
                    </li>
                    <li class="breadcrumb-item active">
                      {{ selectedModule.moduleName }}
                    </li>
                  </ol>
                </nav>
                <h2 class="module-title">
                  <i [class]="getModuleIcon(selectedModule)" class="me-2"></i>
                  {{ selectedModule.moduleName }}
                </h2>
              </div>

              <!-- Video Section -->
              <div class="video-section" *ngIf="safeVideoUrl || videoLoading">
                <div class="video-container">
                  <div class="video-wrapper">
                    <div *ngIf="videoLoading" class="video-loading">
                      <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                      </div>
                      <p>Loading video...</p>
                    </div>

                    <iframe
                      *ngIf="safeVideoUrl && !videoLoading"
                      [src]="safeVideoUrl"
                      frameborder="0"
                      allowfullscreen
                      class="video-player"
                      (load)="onVideoLoad()"
                    >
                    </iframe>

                    <div
                      class="video-overlay"
                      *ngIf="!videoWatched && !videoLoading && safeVideoUrl"
                      (click)="startWatchingVideo()"
                    >
                      <div class="play-button">
                        <i class="fas fa-play"></i>
                      </div>
                    </div>
                  </div>

                  <div class="video-status" *ngIf="videoWatched">
                    <div class="alert alert-success">
                      <i class="fas fa-check-circle me-2"></i>
                      Video completed successfully!
                    </div>
                  </div>
                </div>
              </div>

              <!-- Module Description -->
              <div
                class="module-description"
                *ngIf="selectedModule.description"
              >
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0">
                      <i class="fas fa-info-circle me-2"></i>
                      Module Overview
                    </h5>
                  </div>
                  <div class="card-body">
                    <p
                      class="card-text"
                      [innerHTML]="selectedModule.description"
                    ></p>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons">
                <div class="row g-3">
                  <div
                    class="col-md-6"
                    *ngIf="
                      (videoWatched || selectedModule.isCompleted) &&
                      safeVideoUrl
                    "
                  >
                    <button
                      class="btn btn-success btn-lg w-100 complete-btn"
                      [class.completed]="selectedModule.isCompleted"
                      (click)="markCurrentModuleAsCompleted()"
                      [disabled]="
                        selectedModule.isCompleted ||
                        (!videoWatched && !selectedModule.isCompleted)
                      "
                    >
                      <i
                        class="fas fa-check me-2"
                        *ngIf="selectedModule.isCompleted"
                      ></i>
                      <i
                        class="fas fa-medal me-2"
                        *ngIf="!selectedModule.isCompleted"
                      ></i>
                      {{
                        selectedModule.isCompleted
                          ? "Completed"
                          : "Mark as Complete"
                      }}
                    </button>
                  </div>

                  <div class="col-md-6" *ngIf="selectedModule.documentPath">
                    <button
                      class="btn btn-outline-primary btn-lg w-100 download-btn"
                      (click)="downloadModulePdf(selectedModule)"
                    >
                      <i class="fas fa-file-pdf me-2"></i>
                      Download PDF
                      <i class="fas fa-download ms-2"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Assignment Section -->
              <div class="assignment-section" *ngIf="allModulesCompleted">
                <div class="card assignment-card">
                  <div class="card-body text-center">
                    <div class="achievement-icon">
                      <i class="fas fa-trophy"></i>
                    </div>
                    <h3 class="card-title">🎉 Congratulations!</h3>
                    <p class="card-text">
                      You've completed all modules! Download your assignment and
                      take the quiz to finish your learning journey.
                    </p>

                    <div class="final-actions">
                      <div class="row g-3 justify-content-center">
                        <div class="col-md-6">
                          <!-- <button class="btn btn-primary btn-lg w-100" 
                                  (click)="downloadAssignment()"
                                  [disabled]="courseDetail.assignmentDownloadStatus==1 || isDownloading">
                            <i class="fas fa-spinner fa-spin me-2" *ngIf="isDownloading"></i>
                            <i class="fas fa-download me-2" *ngIf="!courseDetail.assignmentDownloadStatus && !isDownloading"></i>
                            <i class="fas fa-check me-2" *ngIf="courseDetail.assignmentDownloadStatus && !isDownloading"></i>
                            {{ isDownloading ? 'Downloading...' : 
                               courseDetail.assignmentDownloadStatus ? 'Assignment Downloaded' : 'Download Assignment' }}
                          </button> -->

                          <button
                            class="btn btn-primary btn-lg w-100"
                            (click)="downloadAssignment()"
                            [disabled]="isButtonDisabled()"
                          >
                            <i
                              class="fas fa-spinner fa-spin me-2"
                              *ngIf="isDownloading"
                            ></i>
                            <i
                              class="fas fa-download me-2"
                              *ngIf="!dstatus && !isDownloading"
                            ></i>
                            <i
                              class="fas fa-check me-2"
                              *ngIf="dstatus === 1 && !isDownloading"
                            ></i>
                            {{
                              isDownloading
                                ? "Downloading..."
                                : dstatus === 1
                                ? "Assignment Downloaded"
                                : "Download Assignment"
                            }}
                          </button>
                        </div>

                        <div class="col-md-6" *ngIf="courseDetail.quizPath">
                          <button
                            class="btn btn-warning btn-lg w-100 quiz-btn"
                            (click)="startQuiz()"
                            [disabled]="quizTaken"
                          >
                            <i
                              class="fas fa-clipboard-check me-2"
                              *ngIf="!quizTaken"
                            ></i>
                            <i class="fas fa-trophy me-2" *ngIf="quizTaken"></i>
                            {{ quizTaken ? "Quiz Completed" : "Take Quiz" }}
                          </button>
                        </div>
                      </div>

                      <!-- Assignment Status Display -->
                      <div
                        class="assignment-status mt-3"
                        *ngIf="courseDetail.assignmentDownloadStatus"
                      >
                        <div class="alert alert-success">
                          <i class="fas fa-check-circle me-2"></i>
                          Assignment has been downloaded successfully!
                        </div>
                      </div>

                      <!-- Quiz Status Display -->
                      <div class="quiz-status mt-3" *ngIf="quizTaken">
                        <div class="alert alert-info">
                          <i class="fas fa-trophy me-2"></i>
                          Quiz completed with score: {{ quizScore }}%
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- No Module Selected -->
            <div *ngIf="!selectedModule" class="no-selection">
              <div class="empty-state text-center">
                <div class="empty-icon">
                  <i class="fas fa-play-circle"></i>
                </div>
                <h3>Ready to Start Learning?</h3>
                <p class="text-muted">
                  Select a module from the sidebar to begin your educational
                  journey
                </p>
                <div class="start-hint">
                  <i class="fas fa-arrow-left me-2"></i>
                  Choose a module to get started
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Course Completion Status -->
  <div
    class="course-completion-status"
    *ngIf="
      allModulesCompleted && courseDetail.assignmentDownloadStatus && quizTaken
    "
  >
    <div class="completion-banner">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-auto">
            <div class="completion-icon">
              <i class="fas fa-graduation-cap"></i>
            </div>
          </div>
          <div class="col">
            <div class="completion-text">
              <h4 class="mb-1">🎓 Course Completed Successfully!</h4>
              <p class="mb-0">
                You have finished all modules, downloaded the assignment, and
                completed the quiz.
              </p>
            </div>
          </div>
          <div class="col-auto">
            <button class="btn btn-light" (click)="goBack()">
              <i class="fas fa-arrow-right me-2"></i>
              Continue Learning
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
